# REQ-008.02: Render Pipeline Execution

## Classification

- **Priority:** Essential
- **Stability:** Stable
- **Verification:** Test

## Requirement

When a render command is dequeued from the render command queue, the system SHALL dispatch it to the GPU driver according to its type, supporting: framebuffer clear (with optional depth clear), triangle rendering mode configuration (including per-material color write enable and color combiner mode), mesh patch rendering (vertex transformation, lighting, culling, clipping, and GPU submission), screen-space triangle submission (for simple demos), texture upload, color combiner configuration (combiner mode, material colors, fog parameters), and vsync synchronization with framebuffer swap.

When a frame is submitted for rendering, the system SHALL use RenderMeshPatch as the primary per-frame command type and SHALL delineate frame boundaries with WaitVsync commands.

## Rationale

Centralizing render command execution on a dedicated core ensures deterministic GPU communication timing and allows the command dispatch logic to be extended with new command types without affecting scene management on Core 0.

## Parent Requirements

REQ-008 (Scene Graph/ECS)

## Allocated To

- UNIT-021 (Core 1 Render Executor)
- UNIT-020 (Core 0 Scene Manager)
- UNIT-023 (Transformation Pipeline)
- UNIT-022 (GPU Driver Layer)
- UNIT-024 (Lighting Calculator)

## Interfaces

- INT-020 (GPU Driver API)
- INT-021 (Render Command Format)

## Verification Method

**Test:** Verify that each render command type (ClearFramebuffer, SetTriMode, SetColorCombiner, SubmitScreenTriangle, UploadTexture, WaitVsync) is correctly dispatched to the corresponding GPU driver operation, and that frame statistics (command count, idle spins) are tracked per frame.

## Notes

On the RP2350 platform, the executor runs in an infinite loop on Core 1, spinning with NOP when the queue is empty.
On the PC platform, commands are executed synchronously in the main loop (no queue).
The command dispatch logic is platform-agnostic and shared.

Framebuffer clear is implemented by rendering two full-viewport triangles (color clear) plus two additional far-plane triangles when depth clear is requested. Performance counters are logged every 120 frames via defmt (RP2350) or tracing (PC).

**Z-prepass rendering pattern:** The per-material color write enable (COLOR_WRITE_EN in RENDER_MODE) supports a Z-prepass workflow: first render all opaque geometry with COLOR_WRITE_EN=0 and Z_WRITE_EN=1 to populate the Z-buffer, then re-render with COLOR_WRITE_EN=1 and Z_WRITE_EN=0 using EQUAL depth compare.
Combined with early Z rejection (REQ-005.04), this eliminates overdraw cost for the color pass since every fragment either passes (exact depth match) or is rejected early.

**Color combiner configuration:** Material state now includes the color combiner mode in addition to existing RENDER_MODE flags.
The color combiner mode, material colors (MAT_COLOR0, MAT_COLOR1), and fog parameters are configured per-material via dedicated GPU registers (see INT-010) and may be set as part of the SetTriMode or a separate SetColorCombiner command.
