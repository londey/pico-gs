# REQ-005.01: Framebuffer Management

## Classification

- **Priority:** Important
- **Stability:** Stable
- **Verification:** Demonstration

## Requirement

When the host writes a 512-byte-aligned SDRAM address to the FB_CONFIG.COLOR_BASE field (INT-010), the system SHALL direct all subsequent triangle rasterization output to that framebuffer base address in 4×4 block-tiled layout.

When the host writes a 512-byte-aligned SDRAM address to the FB_DISPLAY.FB_ADDR field (INT-010), the system SHALL begin scanning out from that framebuffer base address at the next VSYNC boundary.

When the host issues a MEM_FILL command (REQ-005.08) targeting the active back-buffer base address with a desired fill color, the system SHALL write that fill value to every 16-bit pixel location of the back-buffer (whose word count is derived from FB_CONFIG.WIDTH_LOG2 and FB_CONFIG.HEIGHT_LOG2 per INT-010) using sequential SDRAM burst writes at full available bandwidth.

## Rationale

Separate draw and display framebuffer pointers enable double-buffering, which prevents visible tearing by ensuring the display controller reads from a completed frame while the rasterizer writes to a different buffer.
The SDRAM arbiter (UNIT-007) manages concurrent access from the display controller and rasterizer in the unified 100 MHz clock domain, with no CDC overhead between requestors and the SDRAM interface (see INT-011).

## Parent Requirements

- REQ-005 (Blend/Frame Buffer Store)

## Allocated To

- UNIT-007 (Memory Arbiter)
- UNIT-008 (Display Controller)
- UNIT-006 (Pixel Pipeline)

## Interfaces

- INT-011 (SDRAM Memory Layout)
- INT-010 (GPU Register Map)

## Verification Method

**Demonstration:** The system SHALL meet the following acceptance criteria:

- [ ] FB_CONFIG.COLOR_BASE field sets where triangles render
- [ ] FB_DISPLAY.FB_ADDR field sets which buffer is scanned out
- [ ] Buffer swap (changing FB_DISPLAY.FB_ADDR) takes effect at next VSYNC
- [ ] MEM_FILL command fills the active back-buffer at full bandwidth with word count equal to `(1 << WIDTH_LOG2) * (1 << HEIGHT_LOG2)`
- [ ] 512-byte-aligned addresses allow multiple buffers in 32 MB SDRAM

---


## Notes

User Story: As a firmware developer, I want to configure draw target and display source addresses, so that I can implement double-buffering without tearing.

Framebuffer configuration registers (FB_CONFIG, FB_DISPLAY) may be configured autonomously by the FPGA boot sequence (REQ-001.04) via pre-populated command FIFO entries, prior to any host SPI communication.
Host software configures framebuffer addresses during initialization, which must conform to the 512-byte alignment and address range constraints defined in INT-011 (SDRAM Memory Layout).

**Arbitration timing**: The SDRAM arbiter (UNIT-007) operates in the unified 100 MHz clock domain shared by the GPU core and SDRAM.
Display scanout (highest priority) and rasterizer writes (lower priority) are arbitrated without CDC overhead, enabling back-to-back SDRAM grants on consecutive clock cycles.
See INT-011 for bandwidth budget details.

**SDRAM Burst Access:**
The 4×4 block-tiled layout ensures that framebuffer reads and writes are issued as 16-word bursts aligned to SDRAM rows.
Display scanout burst reads reduce arbitration cycles consumed by display prefetch, freeing grant opportunities for rasterizer writes on arbiter port 1.
The write-coalescing buffer collects pixels within each tile and issues a single burst write per tile.
See UNIT-007, UNIT-008, and INT-011 for bandwidth budget details.
