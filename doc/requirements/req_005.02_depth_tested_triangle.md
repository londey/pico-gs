# REQ-005.02: Depth Tested Triangle

## Classification

- **Priority:** Important
- **Stability:** Stable
- **Verification:** Test

## Requirement

When the host sets Z_TEST=1 in the RENDER_MODE register and a triangle is rasterized, the system SHALL read the Z-buffer value at each fragment position, compare the interpolated fragment depth against the stored depth using the configured comparison function, and discard fragments that fail the test.

When the host sets Z_WRITE=1 in the RENDER_MODE register and a fragment passes the depth test, the system SHALL write the fragment's interpolated depth value to the Z-buffer at that position.

## Rationale

Depth testing ensures overlapping triangles render in correct depth order regardless of submission order.
Z-buffer read/write operations are performed by the pixel pipeline (UNIT-006) through the SDRAM arbiter (UNIT-007), which operates in the unified 100 MHz clock domain shared by the GPU core and SDRAM.
This eliminates CDC latency on Z-buffer access paths, improving effective throughput for depth-heavy scenes.

## Parent Requirements

- REQ-005 (Blend/Frame Buffer Store)

## Allocated To

- UNIT-005 (Rasterizer)
- UNIT-006 (Pixel Pipeline)
- UNIT-007 (Memory Arbiter)

## Interfaces

- INT-010 (GPU Register Map)
- INT-011 (SDRAM Memory Layout)

## Verification Method

**Test:** Two VER documents provide Test-level coverage for this requirement:

- **VER-002** (tb_early_z) — Verilator unit test for the `early_z.sv` module.
  Drives the module with fragment depth inputs and a pre-loaded Z-buffer model, verifying that fragments failing the LEQUAL comparison are discarded and that passing fragments correctly update the Z-buffer.
  Covers Z_TEST=1, Z_WRITE=1, and Z_WRITE=0 configurations, and Z-buffer clear via ALWAYS compare mode.
- **VER-011** (depth-tested overlapping triangles golden image) — Pipeline integration test that renders two overlapping triangles with known depth values through the full RTL hierarchy.
  The rendered framebuffer is compared pixel-exactly against the approved golden image at `spi_gpu/tests/golden/depth_test.ppm`, confirming that the near triangle occludes the far triangle at every overlapping pixel.

Acceptance criteria (satisfied jointly by VER-002 and VER-011):

- RENDER_MODE Z_TEST=1 enables depth comparison; fragments failing LEQUAL are discarded.
- RENDER_MODE Z_WRITE=1 causes passing fragments to write their depth to the Z-buffer.
- Z-buffer is stored in SDRAM separately from the color framebuffer (INT-011).
- Depth comparison is less-than-or-equal (closer pixels win).
- Z values interpolate correctly across the triangle surface.
- Z-buffer can be cleared independently of the color buffer (ALWAYS compare + Z_WRITE=1 with Z=0xFFFF).

---


## Notes

User Story: As a firmware developer, I want to enable Z-buffer testing, so that overlapping triangles render in correct depth order.

**Implementation note (early Z optimization):** When Z_TEST_EN=1 and Z_COMPARE is not ALWAYS, the Z-buffer read and comparison may be performed before texture fetch as an optimization (see REQ-005.04).
This does not change functional behavior — the same fragments pass or fail — but rejected fragments skip texture and blending stages, reducing SDRAM bandwidth consumption.
The Z-buffer write remains at the end of the pipeline regardless of early Z status.

**Z-buffer timing**: Z-buffer reads and writes go through SDRAM arbiter port 2 (UNIT-007).
With the GPU core and SDRAM in the same 100 MHz clock domain, Z-buffer read-compare-write sequences incur no CDC synchronizer delays, enabling the pixel pipeline to sustain higher fragment throughput in depth-intensive scenes.

**Burst mode opportunity**: When fragments arrive in scanline order (sequential screen-space X positions from UNIT-005), Z-buffer reads and writes access addresses within the same 4x4 tile block (INT-011).
The SDRAM arbiter (UNIT-007) can exploit burst mode for Z-buffer accesses within a tile, amortizing the row activation (tRCD) and CAS latency overhead across multiple fragments and improving effective Z-buffer throughput for horizontally adjacent fragments.
