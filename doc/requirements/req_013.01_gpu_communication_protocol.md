# REQ-013.01: GPU Communication Protocol

## Classification

- **Priority:** Essential
- **Stability:** Stable
- **Verification:** Test

## Requirement

When sending any GPU register access, the system SHALL use a 9-byte SPI transaction format where the first byte encodes the register address (bit 7 = read/write flag, bits 6:0 = 7-bit register address) and the remaining 8 bytes carry a 64-bit data payload in MSB-first order, conforming to INT-012.

When the GPU driver is initialized on any host platform, the system SHALL abstract the SPI transport behind the `SpiTransport` trait defined in INT-040, enabling the same GPU driver logic to operate over platform-specific SPI implementations.

When a register write is issued and the GPU command FIFO is full (CMD_FULL signal asserted), the system SHALL block the write operation until CMD_FULL is deasserted before transmitting the SPI transaction.

When communicating with the GPU, the system SHALL support the following operations: register read, register write, bulk memory upload via MEM_ADDR/MEM_DATA auto-increment, triangle submission via sequential COLOR/UV0/VERTEX register writes, color combiner configuration via combiner mode and material color registers, hardware memory fill via MEM_FILL register write, vsync synchronization via VSYNC signal edge detection, and double-buffered framebuffer swap via FB_DRAW/FB_DISPLAY register updates.

## Rationale

The SPI register interface is the sole communication channel between the host and the FPGA-based GPU. Correct framing, flow control, and register sequencing are critical to reliable rendering. Abstracting the SPI transport behind the `SpiTransport` trait (INT-040) allows the same GPU driver logic to operate over both rp235x-hal SPI on the RP2350 and FT232H USB-to-SPI on a PC.

## Parent Requirements

REQ-013 (Host SPI Driver)

## Allocated To

- UNIT-022 (GPU Driver Layer)
- UNIT-035 (PC SPI Driver)

## Interfaces

- INT-010 (GPU Register Map)
- INT-012 (SPI Transaction Format)
- INT-020 (GPU Driver API)
- INT-040 (Host Platform HAL)

## Verification Method

**Test:** Verify that register writes produce correctly framed 9-byte SPI transactions with the write flag clear (bit 7 = 0) and register reads set bit 7 = 1. Verify that write operations block when CMD_FULL is asserted. Verify GPU initialization reads the ID register and rejects unexpected device IDs. Verify that framebuffer swap alternates draw and display addresses correctly.

## Notes

On the RP2350 platform, the SPI transport is implemented via rp235x-hal SPI0 at 25 MHz with manual GPIO chip-select (GPIO5) and GPIO flow control pins (CMD_FULL on GPIO6, CMD_EMPTY on GPIO7, VSYNC on GPIO8). On the PC platform, the SPI transport is implemented via the FT232H USB-to-SPI adapter using the ftdi crate, with flow control signals read via FT232H GPIO pins. GPU identity is verified at startup on both platforms by reading the ID register (expected device ID 0x6702).
