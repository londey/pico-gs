# REQ-004.01: Color Combiner

## Classification

- **Priority:** Important
- **Stability:** Draft
- **Verification:** Test

## Requirement

When the pixel pipeline produces a fragment during rasterization, the system SHALL route that fragment through a two-stage programmable color combiner that accepts texture colors, vertex colors, constant colors, and a combined-output feedback path as inputs and produces a single combined output color.

## Rationale

A two-stage `(A-B)*C+D` color combiner replaces the previous sequential texture blending model.
Each stage independently combines up to seven input sources for RGB and Alpha.
Stage 0's output feeds stage 1 via the COMBINED source, enabling multi-texture blending, fog, and specular-add in a single pass without multi-pass rendering.
This architecture is inspired by the N64 RDP combiner, adapted to the Q4.12 pipeline format.

## Parent Requirements

- REQ-004 (Fragment Processor/Color Combiner — top-level area 4 requirement, not yet created)

## Allocated To

- UNIT-006 (Pixel Pipeline)
- UNIT-010 (Color Combiner)

## Interfaces

- INT-010 (GPU Register Map) — CC_MODE register (0x18), CONST_COLOR register (0x19)

## Functional Requirements

### FR-009-1: Color Combiner Inputs

When the color combiner stage executes, the system SHALL accept the following inputs per stage:

- **TEX_COLOR0 (CC_TEX0):** Sampled and decoded color from texture unit 0 (REQ-003.02)
- **TEX_COLOR1 (CC_TEX1):** Sampled and decoded color from texture unit 1 (REQ-003.02)
- **SHADE0 (CC_SHADE0):** Primary interpolated vertex color from the rasterizer (diffuse)
- **SHADE1 (CC_SHADE1):** Secondary interpolated vertex color from the rasterizer (specular)
- **CONST0 (CC_CONST0):** Per-draw-call constant color 0 (from CONST_COLOR[31:0])
- **CONST1 (CC_CONST1):** Per-draw-call constant color 1 / fog color (from CONST_COLOR[63:32])
- **COMBINED (CC_COMBINED):** Output of the previous combiner cycle (cycle 0 output feeding cycle 1)
- **ONE (CC_ONE):** Constant 1.0
- **ZERO (CC_ZERO):** Constant 0.0

The RGB C slot additionally accepts alpha-to-RGB broadcast sources (e.g., TEX0 alpha, SHADE0 alpha) per INT-010.

### FR-009-2: Two-Stage Combiner Structure

When the firmware writes the CC_MODE register, the system SHALL configure two independent combiner cycles evaluated in sequence:

- Cycle 0: Computes `(A - B) * C + D` using the CC_MODE[31:0] input selectors
- Cycle 1: Computes `(A - B) * C + D` using the CC_MODE[63:32] input selectors; the COMBINED source is the cycle 0 output
- For single-equation rendering, cycle 1 SHALL be configured as a pass-through: A=COMBINED, B=ZERO, C=ONE, D=ZERO

### FR-009-3: Per-Component Operation

When the color combiner evaluates its equation, the system SHALL perform all operations independently per color component (R, G, B, A).
RGB and Alpha equations use independent input selector sets within each cycle.

### FR-009-4: Internal Precision

When the color combiner performs arithmetic, the system SHALL use Q4.12 signed fixed-point format (16-bit values) for all intermediate and output values, with saturation to the valid range per REQ-004.02.

### FR-009-5: Predefined Combiner Modes

When the firmware selects a combiner mode, the system SHALL support at minimum the following configurations expressible via CC_MODE:

- **MODULATE:** Cycle 0: `TEX0 * SHADE0` (basic textured diffuse lighting)
- **DECAL:** Cycle 0: `TEX0` (unlit texture)
- **LIGHTMAP:** Cycle 0: `TEX0 * TEX1` (diffuse texture × pre-computed lightmap)
- **MODULATE_ADD (specular):** Cycle 0: `TEX0 * SHADE0`; Cycle 1: `COMBINED + SHADE1` (diffuse + specular)
- **FOG:** Cycle 0: lit/textured color; Cycle 1: `lerp(COMBINED, CONST1, SHADE0.A)` where SHADE0.A is fog factor

Additional combiner configurations are defined in INT-010.

## Verification Method

**Test:** VER-004 (color_combiner_tb) verifies this requirement using a Verilator testbench that drives the `color_combiner.sv` module with controlled input vectors and compares outputs against a software reference model.

Note: UNIT-010 (Color Combiner) is marked Status: WIP.
VER-004 implementation tracks UNIT-010 stabilization; defer testbench integration until the combiner pipeline timing is resolved.

Acceptance criteria (verified by VER-004):

- CC_MODE register configures both combiner cycles via INT-010 encoding.
- TEX_COLOR0 and TEX_COLOR1 inputs are correctly sourced from texture unit outputs.
- SHADE0 and SHADE1 inputs are correctly sourced from rasterizer interpolation outputs.
- CONST0 and CONST1 are correctly loaded from CONST_COLOR register (0x19).
- COMBINED in cycle 1 equals cycle 0 output.
- MODULATE mode produces `TEX0 * SHADE0` within Q4.12 rounding tolerance.
- DECAL mode passes TEX0 through unchanged (C=ONE, B=D=ZERO).
- LIGHTMAP mode produces `TEX0 * TEX1` within Q4.12 rounding tolerance.
- MODULATE_ADD mode: two-stage specular composition matches reference.
- FOG mode blends combined color toward CONST1 based on fog factor.
- All operations apply per-component (R, G, B, A independently).
- Single-stage pass-through: cycle 1 with A=COMBINED, B=ZERO, C=ONE, D=ZERO produces output equal to cycle 0.

## Notes

This requirement supersedes the previous sequential texture blend model (TEX0 → TEX1 → TEX2 → TEX3).
The color combiner absorbs both the old texture blending and vertex color modulation stages into a single programmable two-stage structure.

All arithmetic uses Q4.12 signed fixed-point format per REQ-004.02.

The specific register encoding for combiner input selectors is defined in INT-010 (GPU Register Map), CC_MODE register.
