# REQ-004.02: Extended Precision Fragment Processing

## Classification

- **Priority:** Essential
- **Stability:** Stable
- **Verification:** Test

## Requirement

When the GPU pixel pipeline processes a fragment through blending, shading, or texture combination stages, the system SHALL represent all intermediate color values in Q4.12 signed fixed-point format (1 sign bit, 3 integer bits, 12 fractional bits = 16 bits per channel) to minimize cumulative precision loss.

## Rationale

8-bit integer fragment processing causes visible banding artifacts in smooth gradients due to cumulative quantization errors across multiple blending stages.
Q4.12 provides 4096 fractional levels per channel and a signed representation that naturally handles the `(A-B)` subtraction in the `(A-B)*C+D` color combiner without requiring separate sign handling.
The 3-bit integer headroom above 1.0 accommodates additive and specular blending without premature saturation.
The 16-bit operand width fits within ECP5 DSP slice input registers (18×18 multipliers).

## Parent Requirements

- REQ-004 (Fragment Processor/Color Combiner)

## Allocated To

- UNIT-005 (Rasterizer) — vertex color interpolation output in Q4.12
- UNIT-006 (Pixel Pipeline) — texture format promotion to Q4.12; alpha blending in Q4.12
- UNIT-010 (Color Combiner) — all combiner arithmetic in Q4.12
- UNIT-022 (GPU Driver Layer)

## Interfaces

- INT-010 (GPU Register Map) — vertex COLOR register input (RGBA8888 UNORM8, promoted to Q4.12)
- INT-020 (GPU Driver API)

## Functional Requirements

### FR-134-1: Q4.12 Fixed-Point Format

The GPU SHALL use Q4.12 signed fixed-point format for all intermediate fragment color values:

- Total width: 16 bits per component (R, G, B, A)
- Format: 1 sign bit, 3 integer bits, 12 fractional bits (standard TI Q notation: Q4.12)
- UNORM color range [0.0, 1.0] maps to [0x0000, 0x1000] (integer value 4096)
- Integer headroom: values up to ~7.999 representable without saturation
- Fractional precision: 1/4096 per step

### FR-134-2: Texture Format Promotion

After texture cache read, pixel data SHALL be promoted from RGBA5652 cache format to Q4.12:

- R5 to Q4.12: expand to span [0.0, 1.0] — `{3'b0, R5, R5[4:1], 3'b0}` (MSB replication to avoid bias)
- G6 to Q4.12: expand to span [0.0, 1.0] — `{3'b0, G6, G6[5:0], 2'b0}` (MSB replication)
- B5 to Q4.12: same as R5
- A2 to Q4.12: expand (00→0x0000, 01→0x0555, 10→0x0AAA, 11→0x1000)
- Fractional bits below the natural precision of the source format are set by MSB replication

### FR-134-3: Vertex Color Promotion

The rasterizer SHALL output interpolated vertex colors in Q4.12 format:

1. Interpolate per-vertex RGBA8888 UNORM8 colors using barycentric coordinates
2. Promote interpolated 8-bit values to Q4.12 UNORM range: `{3'b0, unorm8, unorm8[7:4]}` (MSB replication)

### FR-134-4: Color Combiner Precision

All color combiner operations SHALL be performed in Q4.12 format.
When the color combiner receives inputs (TEX_COLOR0, TEX_COLOR1, SHADE0, SHADE1, CONST0, CONST1, COMBINED), the following arithmetic operations SHALL use Q4.12 precision:

- **MULTIPLY:** `result = (a * b) >> 12` using DSP multiplier (16×16 into 32-bit, shift 12)
- **ADD:** `result = saturate(a + b)` with saturation at Q4.12 max (~7.999)
- **SUBTRACT:** `result = saturate(a - b)` with floor at Q4.12 min (~-8.0); signed arithmetic
- The Q4.12 signed representation allows `(A-B)` to produce correct negative intermediates without separate logic
- All operations apply per-component (R, G, B, A independently)

### FR-134-5: Alpha Blending Precision

Alpha blending operations SHALL be performed in Q4.12 format:

1. Promote destination pixel from RGB565 framebuffer to Q4.12 UNORM (same promotion as FR-134-2)
2. Apply blend equation in Q4.12 format based on RENDER_MODE.ALPHA_BLEND:
   - **ADD:** `result = saturate(src + dst)`
   - **SUBTRACT:** `result = saturate(src - dst)`
   - **BLEND:** `result = src * alpha + dst * (Q4.12_ONE - alpha)` (Porter-Duff source-over)
3. Saturate results to UNORM [0.0, 1.0] range before framebuffer write

### FR-134-6: Framebuffer Conversion

After all blending, the pixel pipeline SHALL convert Q4.12 format to RGB565 for the framebuffer:

1. Apply ordered dithering if RENDER_MODE.DITHER_EN=1 (REQ-005.10)
2. Clamp to UNORM [0.0, 1.0], then extract: R5 = round(R × 31), G6 = round(G × 63), B5 = round(B × 31)
3. Pack into RGB565 format and write to the block-tiled framebuffer
4. Alpha channel is discarded (RGB565 has no alpha storage)

### FR-134-7: Always-On Mode

The Q4.12 fixed-point format SHALL be always enabled.
There is no configurable mode to revert to narrower integer processing.
This simplifies hardware and ensures consistent visual quality.

## Verification Method

**Test:** Execute relevant test suite for fragment processing precision:

- [ ] Texture promotion from RGBA5652→Q4.12 produces correct values for all R5/G6/B5/A2 combinations
- [ ] Vertex color promotion from RGBA8888→Q4.12 preserves full UNORM range
- [ ] MULTIPLY of two UNORM Q4.12 values matches reference (error < 1 LSB at 8-bit output)
- [ ] ADD saturates correctly at Q4.12 max
- [ ] Alpha blend at alpha=0.5 produces correct 50% mix
- [ ] Color combiner chain (two textures + vertex colors + constants) maintains precision
- [ ] Final RGB565 output matches reference within dithering tolerance
- [ ] Framebuffer readback promotion (RGB565→Q4.12) produces correct values

## Notes

The Q4.12 signed format fits within ECP5 DSP slice input registers (18-bit native width; 16-bit operands occupy the lower 16 bits).
Total DSP usage for the combiner and alpha blend stages is approximately 6-10 slices, within the available budget.

The pixel pipeline runs at 100 MHz (`clk_core`), providing a peak throughput of 100 million fragment operations per second.
All SDRAM accesses for framebuffer readback (alpha blending) and texture cache fills occur in the same clock domain, with no CDC overhead.

Promotion from lower-precision formats uses MSB replication (e.g., R5→Q4.12 = `{3'b0, R5, R5[4:1], 3'b0}`) to ensure uniform distribution across the UNORM range, avoiding bias from simple zero-padding.

See DD-011 in design_decisions.md for architectural rationale.
