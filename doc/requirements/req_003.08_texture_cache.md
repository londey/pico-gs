# REQ-003.08: Texture Cache

## Classification

- **Priority:** Important
- **Stability:** Draft
- **Verification:** Test

## Requirement

When the pixel pipeline samples textures during rendering, the system SHALL cache decompressed texel data in per-sampler caches to reduce external SDRAM bandwidth and enable single-cycle bilinear texture filtering.

## Rationale

Texture sampling is memory-intensive. Without caching, every pixel requiring bilinear filtering would perform 4 SDRAM reads (one per texel), plus decompression overhead for BC1 textures. This creates severe SDRAM bandwidth bottlenecks that limit fill rate.

A per-sampler cache architecture solves this by:
1. **Reducing SDRAM bandwidth:** Spatial locality means adjacent pixels often sample the same 4x4 block, achieving >85% cache hit rates
2. **Enabling single-cycle bilinear filtering:** All 4 texels for a 2x2 bilinear quad can be read in parallel from interleaved banks
3. **Amortizing decompression cost:** BC1 blocks are decompressed once per cache fill rather than per pixel
4. **Avoiding cross-sampler contention:** Independent caches for each of the 2 texture samplers eliminate stalls from dual-texture rendering

The reduction from 4 to 2 texture samplers (REQ-003.02) allows a 4x increase in per-sampler cache capacity (from 4096 to 16384 texels), significantly improving cache hit rates for large textures and reducing SDRAM bandwidth pressure.

**Performance Impact (at 100 MHz `clk_core`):**
- **Cache hit:** 1 cycle / 10 ns for 4 bilinear texels (all 4 read in parallel from interleaved banks)
- **Cache miss (with SDRAM burst reads):** ~11-23 cycles to fetch and decompress block from SDRAM (BC1: ~11 cycles / 110 ns, uncompressed formats: ~23 cycles / 230 ns), including CAS latency (CL=3) and row activation overhead
- **Expected hit rate:** >90% for typical scenes (improved from >85% due to 4x larger cache capacity)

Cache miss latency includes SDRAM row activation (tRCD = 18 ns) and CAS latency (CL=3, 30 ns) before the first data word, followed by burst data at one word per cycle.
Burst SDRAM reads (see INT-032) amortize the row activation and CAS latency overhead across the full block fetch.

Note: The texture cache and SDRAM controller share the same 100 MHz clock domain, so cache fill operations are synchronous single-domain transactions with no CDC overhead.

**Resource Cost:**
- 2 independent sampler caches, each with 16384 texels (16K) capacity
- EBR usage per sampler determined by cache geometry (see INT-032 for detailed allocation)
- Total EBR budget must remain within ECP5-25K constraints (REQ-011.02)
- ~800-1600 LUTs for cache tags, comparators, and control logic

## Parent Requirements

REQ-003

## Allocated To

- UNIT-006 (Pixel Pipeline)

## Interfaces

- INT-032 (Texture Cache Architecture)
- INT-010 (GPU Register Map - TEXn_BASE, TEXn_FMT trigger invalidation)
- INT-014 (Texture Memory Layout - source texture block addressing)

## Functional Requirements

### FR-131-1: Per-Sampler Cache Independence

When multiple texture samplers are active, each of the 2 sampler caches SHALL operate independently with no cross-sampler contention or shared state.

### FR-131-2: Cache Capacity

When the system is configured, each sampler cache SHALL store up to 16384 decompressed texels (16K) in RGBA5652 format (18 bits per texel).

### FR-131-3: Single-Cycle Bilinear Access

When a bilinear filtering operation requires a 2x2 texel quad and all 4 texels are cached, the cache SHALL provide all 4 texels in a single clock cycle via interleaved bank access.

### FR-131-4: Cache Invalidation

When firmware writes to a TEXn_BASE or TEXn_FMT register, the system SHALL invalidate the corresponding sampler's cache to prevent stale data access.

### FR-131-5: Format-Agnostic Storage

When texels are stored in the cache, the system SHALL store them in decompressed RGBA5652 format regardless of the source texture format (RGBA4444, BC1, RGB565, RGBA8888, or R8), so that cache reads are format-independent.

## Verification Method

**Test:** Verify cache behavior meets the following acceptance criteria:

- [ ] Each of the 2 sampler caches operates independently with no cross-sampler contention
- [ ] Each sampler cache stores up to 16384 texels in RGBA5652 format
- [ ] Cache correctly stores and retrieves 4x4 texel blocks in RGBA5652 format
- [ ] Set associativity verified by accessing blocks mapping to the same set
- [ ] Any 2x2 bilinear quad reads exactly one texel per bank (single-cycle parallel access)
- [ ] Bilinear texels are read in 1 cycle on cache hit
- [ ] RGBA4444 texels correctly converted to RGBA5652 on cache fill
- [ ] BC1 blocks correctly decompressed to RGBA5652 on cache fill
- [ ] RGB565 texels correctly converted to RGBA5652 on cache fill
- [ ] RGBA8888 texels correctly converted to RGBA5652 on cache fill
- [ ] R8 texels correctly converted to RGBA5652 on cache fill (replicated to RGB)
- [ ] TEXn_BASE write invalidates sampler N's cache (next access is guaranteed miss)
- [ ] TEXn_FMT write invalidates sampler N's cache (next access is guaranteed miss)
- [ ] Invalidating sampler 0 does not affect sampler 1 and vice versa
- [ ] Stale data never served after configuration change
- [ ] Cache miss latency within target: BC1 <=11 cycles (110 ns), RGBA4444 <=23 cycles (230 ns), RGB565 <=23 cycles (230 ns), RGBA8888 <=23 cycles (230 ns), R8 <=23 cycles (230 ns) using SDRAM burst reads
- [ ] Replacement policy avoids thrashing for sequential access patterns
- [ ] Set indexing distributes adjacent blocks across different sets (no systematic aliasing)

## Notes

The cache stores texels in an intermediate format (RGBA5652: R5 G6 B5 A2) that matches framebuffer RGB565 precision and provides minimal alpha support for BC1 transparency.
This 18-bit/texel format aligns with ECP5 EBR native width (1024x18).

Detailed cache architecture (line format, invalidation protocol, set indexing, interleaving, EBR allocation for 16K texels per sampler) is specified in INT-032.

Implementation details (associativity, replacement policy, indexing, EBR usage) are documented in UNIT-006.

The 4x increase in per-sampler cache capacity (from 4096 to 16384 texels) is enabled by reducing from 4 to 2 texture samplers.
The EBR budget for the larger caches must be validated against the ECP5-25K total EBR availability (REQ-011.02).
See DD-010 in design_decisions.md for architectural rationale.
