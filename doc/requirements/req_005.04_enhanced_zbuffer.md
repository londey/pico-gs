# REQ-005.04: Enhanced Z-Buffer

## Classification

- **Priority:** Important
- **Stability:** Stable
- **Verification:** Demonstration

## Requirement

When the host configures the Z_COMPARE field in the RENDER_MODE register, the system SHALL use the specified comparison function (LESS, LEQUAL, EQUAL, GEQUAL, GREATER, NOTEQUAL, ALWAYS, or NEVER) for all subsequent depth tests against the Z-buffer.

When the host writes Z_RANGE_MIN and Z_RANGE_MAX values to the Z_RANGE register, the system SHALL discard any fragment whose interpolated Z value falls outside the range [Z_RANGE_MIN, Z_RANGE_MAX] before performing the depth comparison.

When Z_TEST_EN=1 and Z_COMPARE is not ALWAYS, the system SHALL perform the Z-buffer read and depth comparison before texture fetch (early Z), skipping texture and blending stages for fragments that fail the depth test.

## Rationale

This requirement enables the user story described above.

Configurable compare functions allow reverse-Z rendering (GEQUAL), decal passes (EQUAL), skybox last (ALWAYS), and other standard depth-testing patterns.
Depth range clipping (Z scissor) allows the firmware to discard fragments outside a configurable [Z_RANGE_MIN, Z_RANGE_MAX] sub-range, enabling depth-based effects such as clip planes and layered rendering without CPU-side geometry clipping.
Early Z-test moves the depth comparison before texture fetch, so fragments that would fail the depth test skip texture and blending stages entirely, reducing SDRAM bandwidth for overdraw-heavy scenes.

## Parent Requirements

- REQ-005 (Blend/Frame Buffer Store)

## Allocated To

- UNIT-006 (Pixel Pipeline)
- UNIT-007 (Memory Arbiter)

## Interfaces

- INT-010 (GPU Register Map)
- INT-011 (SDRAM Memory Layout)

## Verification Method

**Demonstration:** The system SHALL meet the following acceptance criteria:

### Compare Functions

- [ ] Set FB_ZBUFFER register with base address
- [ ] Configure Z_COMPARE via RENDER_MODE register
- [ ] Support LESS compare (incoming < zbuffer)
- [ ] Support LEQUAL compare (incoming ≤ zbuffer)
- [ ] Support EQUAL compare (incoming = zbuffer)
- [ ] Support GEQUAL compare (incoming ≥ zbuffer)
- [ ] Support GREATER compare (incoming > zbuffer)
- [ ] Support NOTEQUAL compare (incoming ≠ zbuffer)
- [ ] Support ALWAYS compare (always pass)
- [ ] Support NEVER compare (always fail)
- [ ] Space reserved in register for future stencil operations

### Depth Range Clipping (Z Scissor)

- [ ] Z_RANGE register accepts Z_RANGE_MIN and Z_RANGE_MAX fields (16-bit each)
- [ ] Fragments with interpolated Z < Z_RANGE_MIN are discarded before depth test
- [ ] Fragments with interpolated Z > Z_RANGE_MAX are discarded before depth test
- [ ] Fragments with Z_RANGE_MIN ≤ Z ≤ Z_RANGE_MAX proceed to depth test normally
- [ ] Z_RANGE_MIN=0x0000, Z_RANGE_MAX=0xFFFF passes all fragments (full range, default)
- [ ] Z_RANGE clipping is applied before the depth compare function
- [ ] Discarded fragments do not modify the Z-buffer or color buffer

### Early Z-Test

- [ ] When Z_TEST_EN=1 and Z_COMPARE is not ALWAYS, the Z-buffer read and comparison are performed before texture fetch
- [ ] Fragments that fail early Z do not issue texture reads or blending operations
- [ ] Fragments that pass early Z proceed through the full pixel pipeline
- [ ] When Z_COMPARE=ALWAYS, early Z is bypassed (all fragments proceed to texture/blend)
- [ ] When Z_TEST_EN=0, early Z is bypassed (no Z-buffer read occurs)
- [ ] Early Z produces bit-identical results to late Z for all compare functions

---


## Notes

User Story: As a firmware developer, I want to configure z-buffer compare functions and depth range clipping, so that I can control depth testing behavior (reverse Z, equal test, always pass, Z scissor, early Z rejection, etc.)

The Z_RANGE register provides depth range clipping without requiring CPU-side geometry processing.
When Z_RANGE_MIN=0x0000 and Z_RANGE_MAX=0xFFFF (the default), no fragments are clipped and the feature has zero overhead.

Early Z is a performance optimization only — it does not change functional results.
The Z-buffer write remains at the end of the pipeline regardless of early Z status, ensuring correct behavior for all compare functions and write-enable combinations.

**Burst mode interaction**: Early Z-buffer reads access SDRAM arbiter port 2 (UNIT-007) at the start of the pixel pipeline.
With the 4x4 block-tiled Z-buffer layout (INT-011), fragments arriving in scanline order from the rasterizer (UNIT-005) address Z values within the same tile block, enabling SDRAM burst read mode which amortizes row activation and CAS latency across multiple fragments within a tile.
Combined with early Z rejection, burst mode further reduces SDRAM bandwidth consumption: rejected fragments skip texture fetch (no port 3 burst needed), and the early Z read itself completes faster via burst transfer for adjacent fragments within the same tile.
