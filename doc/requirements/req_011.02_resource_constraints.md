# REQ-011.02: Resource Constraints

## Classification

- **Priority:** Essential
- **Stability:** Stable
- **Verification:** Analysis

## Requirement

The system SHALL meet the resource constraints defined in the specification.

## Rationale

These targets ensure the system meets performance, resource, and reliability expectations.

## Parent Requirements

- REQ-011 (System Constraints)

## Allocated To

- UNIT-001 (SPI Slave Controller)
- UNIT-002 (Command FIFO)
- UNIT-003 (Register File)
- UNIT-007 (Memory Arbiter)

## Interfaces

- INT-010 (GPU Register Map)
- INT-011 (SDRAM Memory Layout)

## Referenced By

- UNIT-001 (SPI Slave Controller) — Implements Requirements includes REQ-011.02
- UNIT-002 (Command FIFO) — resource-constrained unit
- UNIT-003 (Register File) — resource-constrained unit
- UNIT-007 (Memory Arbiter) — resource-constrained unit

## Functional Requirements

### FR-051-1: FPGA Resource Budget

The GPU design SHALL fit within the following ECP5-25K resource budget:

| Resource | Budget | Allocation |
|----------|--------|------------|
| EBR (9kb blocks) | ≤37 of 56 (66%) | 32 texture cache (16 per sampler × 2 samplers) + 1 dither matrix + 2 color grade LUT (double-buffered) + 1 scanline FIFO + 1 SPI receive FIFO |
| DSP slices (18x18) | ≤16 of 28 (57%) | Q4.12 multipliers for color combiner, Gouraud shade, alpha blend |
| SERDES channels | 4 of 4 | DVI TMDS (3 data + 1 clock) |

### FR-051-2: Pipeline Timing

All pixel pipeline stages SHALL be fully pipelined with no throughput reduction:

- Depth range clipping: combinational comparison (0 additional cycles, ~20-40 LUTs for two 16-bit comparators)
- Early Z-test: reuses existing Z-buffer read port (0 additional cycles when bypassed; ~0 additional LUTs, reorders existing Z-test logic)
- Texture format promotion: combinational (0 additional cycles)
- Ordered dithering: 1 cycle EBR read (pipelined, no stall)
- Color grading LUT: 2 core clock cycle scanout latency (20 ns at 100 MHz, within the 40 ns pixel period)

## Verification Method

**Analysis:** Measure actual performance/resource usage against targets.

- [ ] EBR usage ≤37 blocks after synthesis
- [ ] DSP slice usage ≤16 after synthesis
- [ ] SERDES usage = 4 channels
- [ ] No pipeline throughput reduction from dithering or Q4.12 math
- [ ] Color grading LUT latency ≤2 cycles at scanout

## Notes

Non-functional requirement. See specifications for specific numeric targets.

EBR budget is 37 blocks, accommodating: per-sampler texture caches (32 EBR), ordered dithering matrix (1 EBR, REQ-005.10), color grading LUT double-buffer (2 EBR, REQ-006.03 FR-133-4), display controller scanline FIFO (1 EBR, UNIT-008), and SPI receive FIFO (1 EBR, UNIT-001).
The scanline FIFO (1024×16 sync_fifo) infers as a DP16KD block RAM now that memory reads are separated from the async reset path.
DSP budget applies to Q4.12 fixed-point multipliers (REQ-004.02).
Q4.12 is 16 bits wide (4 integer + 12 fractional); 16×16 multiplication fits within the ECP5 18×18 DSP slice, so the DSP count is unchanged from the 10.8 (18-bit) design.

**Texture cache EBR allocation (2 samplers):** Each texture sampler cache uses 16 EBR (4 interleaved banks × 4 EBR per bank, each 1024×18-bit), providing 16,384 texels (16K) per sampler.
Two samplers × 16 EBR = 32 EBR total for texture cache.
This is a significant increase from the previous 4-sampler configuration (4 EBR per sampler × 4 samplers = 16 EBR for 4096 texels per sampler), but the 4× larger per-sampler cache substantially improves hit rates and reduces SDRAM bandwidth pressure for dual-texture rendering workloads.
The 4-bank interleaved arrangement allows all 4 bilinear sampling texels to be read in a single cycle.
The color combiner module replaces the previous sequential texture blend logic and reuses the same DSP slices; no additional DSP resources are required.

The command FIFO (UNIT-002) uses distributed RAM (LUTs) rather than EBR.
The 72-bit × 512-deep command FIFO consumes approximately 36,864 bits of distributed RAM, which is accounted for in the LUT budget rather than the EBR budget.
The 512-entry depth was chosen to absorb a full frame of GPU commands without stalling the host, amortizing the SPI transaction overhead over longer bursts.

**SDRAM controller resource estimate (UNIT-007, SDRAM controller):** The SDRAM controller (sdram_controller.sv) requires approximately 200-300 LUTs and 100-150 FFs for the 8-state FSM (INIT, IDLE, ACTIVATE, READ, WRITE, PRECHARGE, REFRESH, DONE), address decomposition (byte address to bank/row/column), CAS latency pipeline (3-stage shift register), refresh timer (14-bit counter for 781-cycle interval), initialization sequence counter (15-bit for 200 us wait), burst counter (8-bit burst_remaining), preemption logic, and data routing.
This is larger than the original ~150 LUT async SRAM controller because SDRAM requires initialization, auto-refresh, and explicit row activation/precharge management.
No additional EBR or DSP resources are required.

**PLL resource note:** The SDRAM controller requires a 90-degree phase-shifted 100 MHz clock output from the ECP5 PLL.
The ECP5 EHXPLLL primitive supports up to 4 clock outputs with configurable phase shift.
The existing PLL already uses 3 outputs (clk_core 100 MHz, clk_pixel 25 MHz, clk_tmds 250 MHz).
Adding the SDRAM clock as the 4th output consumes the last available PLL output but requires no additional PLL primitives.
