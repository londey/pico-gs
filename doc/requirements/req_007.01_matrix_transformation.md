# REQ-007.01: Matrix Transformation Pipeline

## Classification

- **Priority:** Essential
- **Stability:** Stable
- **Verification:** Test

## Requirement

When transforming a vertex for GPU submission, the system SHALL execute the MVP transformation pipeline in the following stages: MVP matrix multiplication (object space to clip space), perspective divide (clip space to normalized device coordinates), and viewport mapping (NDC to screen pixels for a 640x480 display), producing screen-space coordinates suitable for GPU register packing.

When computing vertex attributes for rasterization, the system SHALL provide: normal vector transformation for lighting, back-face culling via screen-space winding order test, construction functions for perspective projection, look-at view, and rotation matrices, frustum plane extraction from the MVP matrix, axis-aligned bounding box (AABB) frustum culling, per-patch clip plane classification, and triangle clipping against frustum planes (Sutherland-Hodgman).

When rendering a mesh that uses quantized u16 vertex positions per INT-031, the system SHALL pre-multiply the model matrix with a quantization bias matrix that maps the [0, 65535] quantization range back to model-space coordinates using the mesh's AABB, such that `bias_matrix = translate(aabb_min) × scale(aabb_extent / 65535.0)` and `adjusted_model = original_model × bias_matrix`.

## Rationale

The host CPU performs all vertex transformation and projection so that the GPU receives pre-transformed screen-space triangles, keeping the GPU hardware focused on rasterization and fragment processing without requiring a hardware vertex shader.

## Parent Requirements

REQ-007 (Vertex Transformation)

## Allocated To

- UNIT-023 (Transformation Pipeline)
- UNIT-021 (Core 1 Render Executor)
- UNIT-020 (Core 0 Scene Manager)
- UNIT-026 (Inter-Core Queue)

## Interfaces

- INT-020 (GPU Driver API)
- INT-021 (Render Command Format)

## Verification Method

**Test:** Verify that a known object-space vertex transformed by a known MVP matrix produces the expected screen-space coordinates (x in 0..639, y in 0..479, z in 0.0..1.0). Verify that back-face culling correctly identifies front-facing (counter-clockwise) and back-facing (clockwise) triangles. Verify that normal transformation preserves unit length.

## Notes

The implementation uses the `glam` crate for matrix and vector math with hardware FPU.
Perspective divide guards against near-zero W values.
Viewport mapping flips the Y axis (NDC +Y up to screen +Y down).
The Z output is clamped to [0, 1] for the GPU's 16-bit depth buffer per INT-010.
