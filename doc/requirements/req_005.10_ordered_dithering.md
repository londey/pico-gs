# REQ-005.10: Ordered Dithering

## Classification

- **Priority:** Important
- **Stability:** Stable
- **Verification:** Demonstration

## Requirement

When the pixel pipeline writes a fragment color to the RGB565 framebuffer, the system SHALL apply ordered dithering before the format conversion to reduce visible color banding artifacts in smooth gradients.

## Rationale

Converting Q4.12 fixed-point fragment colors to RGB565 format discards fractional bits, causing visible banding in smooth gradients.
Ordered dithering trades spatial resolution for color resolution, creating the perception of smooth gradients.

## Parent Requirements

- REQ-005 (Blend/Frame Buffer Store)

## Related Requirements

- REQ-005.06 (Framebuffer Format)
- REQ-004.02 (Extended Precision Fragment Processing)

## Allocated To

- UNIT-006 (Pixel Pipeline)
- UNIT-022 (GPU Driver Layer)

## Interfaces

- INT-010 (GPU Register Map) — RENDER_MODE register (0x30), DITHER_EN bit
- INT-020 (GPU Driver API) — `gpu_set_dither_mode()`

## Functional Requirements

### FR-132-1: Dither Matrix Storage

The GPU SHALL store a 16x16 blue noise dither matrix in 1 EBR block (256 entries x 18 bits, using native ECP5 1024x18 configuration). The matrix stores 6 bits per component (R, G, B) packed into 18 bits per entry. The matrix is baked into FPGA configuration at synthesis time and is not runtime-configurable.

### FR-132-2: Dither Value Scaling

For each pixel, the GPU SHALL:
1. Read dither matrix entry indexed by `{screen_y[3:0], screen_x[3:0]}`
2. Scale the 6-bit dither value per channel based on target bit depth:
   - R and B (Q4.12 → 5-bit output, discarding 7 fractional bits): use top 6 bits of 6-bit value (range 0-63), left-shifted to align with fractional bit position
   - G (Q4.12 → 6-bit output, discarding 6 fractional bits): use top 6 bits of 6-bit value (range 0-63), left-shifted to align with fractional bit position

### FR-132-3: Dithering Algorithm

For each color component in Q4.12 fixed-point format, the GPU SHALL:
1. Extract the integer part and relevant fractional bits
2. Add the scaled dither value to the fractional bits below the RGB565 threshold
3. If the addition carries into the integer part, increment the integer
4. Extract upper bits from the integer part for RGB565: R[4:0] (top 5 integer bits), G[5:0] (top 6 integer bits), B[4:0] (top 5 integer bits)

This effectively rounds up or down based on the dither pattern, distributing quantization error spatially.

### FR-132-4: Dithering Control

The firmware SHALL be able to enable or disable dithering via the DITHER_EN bit in the RENDER_MODE register (0x30):
- DITHER_EN=1: dithering enabled (default)
- DITHER_EN=0: disabled; Q4.12 values truncate directly to RGB565 without dithering

## Verification Method

**Demonstration:** The system SHALL meet the following acceptance criteria:

- [ ] Set DITHER_EN bit in RENDER_MODE register to enable/disable dithering
- [ ] Dithering applies to all framebuffer writes after alpha blending
- [ ] 16x16 blue noise dither matrix stored in EBR (1 block)
- [ ] Dither values scaled per-channel to align with fractional bits below RGB565 threshold (Q4.12 source precision)
- [ ] Smooth gradients visible in dithered RGB565 output (no banding)
- [ ] Dithering can be disabled for pixel-perfect rendering
- [ ] No visible tiling artifacts from 16x16 pattern at normal viewing distance
- [ ] Dithering is fully pipelined (1 cycle EBR read at 100 MHz / 10 ns, no throughput reduction)

## Notes

Blue noise dithering is preferred over Bayer or white noise because it minimizes low-frequency artifacts and pushes quantization noise to high frequencies (less perceptible to the human visual system). The 16x16 pattern is small enough to fit in 1 EBR while being large enough to avoid visible tiling in most content.

See DD-012 in design_decisions.md for architectural rationale.
