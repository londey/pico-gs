# REQ-014.01: Lightmapped Static Mesh

## Classification

- **Priority:** Important
- **Stability:** Stable
- **Verification:** Test

## Requirements

When the render executor processes a mesh patch tagged as a lightmapped static mesh, the system SHALL configure the GPU registers to enable dual-texture sampling, setting TEX0 to the diffuse texture, TEX1 to the lightmap, and the color combiner mode to `(VERTEX_COLOR + TEX_COLOR0) * TEX_COLOR1`.

When the GPU pixel pipeline evaluates a fragment for a lightmapped static mesh patch, the system SHALL sample TEX0 using uv0, sample TEX1 using uv1, add the interpolated vertex color (color0) to the TEX0 sample, and multiply the result by the TEX1 sample to produce the final fragment color.

## Rationale

Lightmapped static meshes are the primary render mode for static level geometry.
Two sets of UVs are used: one for the diffuse (albedo) texture and one for a pre-baked lightmap.
Vertex colors provide per-vertex dynamic point light contributions (up to 4 lights), which are added to the diffuse texture before modulation by the lightmap.

## Parent Requirements

- REQ-014 (Render Modes)

## Allocated To

- UNIT-006 (Pixel Pipeline) — GPU-side dual-texture sampling and combiner evaluation
- UNIT-021 (Core 1 Render Executor) — host-side render command dispatch
- UNIT-022 (GPU Driver Layer) — combiner mode and texture unit register configuration

## Interfaces

- INT-010 (GPU Register Map)
- INT-014 (Texture Memory Layout)
- INT-020 (GPU Driver API)

## Verification Method

**Test:** VER-014 (textured cube golden image) provides integration-level coverage for dual-texture rendering with the MODULATE combiner.
A dedicated lightmapped mesh golden image test targeting the `(VERTEX_COLOR + TEX_COLOR0) * TEX_COLOR1` combiner expression is required; pending assignment of a VER document.

Acceptance criteria:

- GPU register write sequence enables TEX0 and TEX1 with correct base addresses and formats.
- Fragment color equals `clamp((color0 + tex0_sample) * tex1_sample, 0, 1)` per channel at the pixel pipeline output.
- UV0 addresses the diffuse texture; UV1 addresses the lightmap independently.
- Z-buffer depth testing operates in parallel with dual-texture sampling.

## Notes

Two sets of UVs are used: UV0 for the diffuse (albedo) texture and UV1 for the pre-baked lightmap.
Vertex color (color0) provides per-vertex dynamic point light contributions, added to the diffuse texture before lightmap modulation.
The combiner equation is evaluated by UNIT-010 (Color Combiner) via the `cc_mode` register field (INT-010); the dual-texture UV path is provided by the `tri_uv0`, `tri_uv1`, `tri_q`, `tex0_cfg`, and `tex1_cfg` register outputs wired to UNIT-006 (Pixel Pipeline).
